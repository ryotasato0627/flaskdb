# FlaskDB 今後の拡張案

現状の構成と設計方針を踏まえ、学習目的に沿った拡張の方向性を整理しました。

---

## 現状の整理

| 領域 | 実装済み |
|------|----------|
| 認証 | JWT アクセストークン、ログイン |
| ユーザー | 登録・取得 |
| ノート | CRUD、`user_id` による所有者チェック |
| アーキテクチャ | routes / services / repository / schemas / models |
| テスト | Service 層の単体テスト（Repository モック） |
| CI | pytest（3.11, 3.12）、SQLite メモリ |

README の Trade-offs にある通り、認可の整理や権限ごとの操作制御は「将来的に検討」とされています。

---

## 拡張の方向性

### 1. 認可・権限の整理（推奨：まずここから）

**目的**: 「個人利用のみ」の前提を保ちつつ、認可ロジックを明示的にする。

- **現状**: `NoteService.check_permission(note, user_id)` で所有者チェックを実施しているが、ルートによっては「自分のノート一覧だけ返す」などが曖昧になり得る。
- **拡張案**:
  - **自分のノートだけ返す**: `get_all_notes(user_id)` にして、Repository で `user_id` でフィルタ。他ユーザーのノートを返さないことを保証する。
  - **認可の共通化**: 「このリソースにアクセスしてよいか」を判定する小さなモジュール（例: `app/utils/permission.py`）を用意し、Service から呼ぶ。責務は「認可の判断」に限定する。
- **学習効果**: 認証（誰か）と認可（何をしてよいか）の分離、Service 層での一貫した権限チェックの置き場所を学べる。

---

### 2. ノート機能の拡張

**目的**: 既存の CRUD とレイヤー構成を活かした、小さな機能追加。

- **タグまたはカテゴリ**  
  - ノートに `tags`（多対多）や `category_id`（外部キー）を追加。  
  - 「タグで絞り込み」「カテゴリ一覧」を Service / Repository に追加。  
  - 既存の「routes → services → repository」の流れのまま拡張できる。

- **下書きと公開**  
  - `status` カラム（例: `draft` / `published`）を追加。  
  - 一覧取得で「自分のノート」かつ「status でフィルタ」を Repository で行う。  
  - 公開範囲の考え方（現状は全ノートが自分用なので「下書き」の意味づけ）を設計する練習になる。

- **更新日時とソート**  
  - モデルに `updated_at` を追加（既に `User.to_dict` で `update_at` 参照があるため、モデルとの整合を取る良い機会）。  
  - 一覧 API で `sort=created_at` / `sort=updated_at`、`order=asc|desc` などのクエリパラメータを受け取り、Repository でソート。  
  - クエリのバリデーションは Service 層で行う方針と一致する。

---

### 3. API の使いやすさ・一貫性

**目的**: クライアントが使いやすい形にそろえる。

- **ページネーション**  
  - `GET /notes?page=1&per_page=20` のようにし、Repository で `LIMIT/OFFSET`（または `LIMIT/OFFSET` の抽象）。  
  - レスポンスに `total` や `page` を含めるかどうかをスキーマで決める。

- **検索**  
  - `GET /notes?q=キーワード` でタイトル・本文の部分一致。  
  - 検索条件の組み立ては Service、SQL 組み立ては Repository に閉じる。

- **エラー形式の統一**  
  - 既存の `error_response` を活かし、HTTP ステータスと body の形式（例: `code`, `message`, `details`）をルール化。  
  - バリデーションエラー（Pydantic）と業務エラー（ValueError / PermissionError）で同じフォーマットにそろえると、クライアント実装が楽になる。

---

### 4. テストの拡張

**目的**: 「業務ロジックの検証」を維持しつつ、少し範囲を広げる。

- **認可まわりのテスト**  
  - 「他ユーザーのノートを更新・削除しようとしたときに PermissionError」などを Service の単体テストで明示的に書く。  
  - モックは既存と同様に Repository のみでよい。

- **ルートの軽いテスト**  
  - 「正しいスキーマで 201 が返る」「バリデーション違反で 400」程度を、Flask のテストクライアントで行う。  
  - 学習範囲として「E2E は対象外」とあるので、あくまで「ルートの入出力」に限定するとよい。

- **テスト用 DB**  
  - CI では SQLite メモリのままでもよいが、ローカルで PostgreSQL を使う場合は、テスト用 DB やコンテナの利用方法を README に 1 行だけ書いておくと再現しやすい。

---

### 5. インフラ・運用まわり（余力があれば）

**目的**: 本番に近い環境に触れる程度に留める。

- **環境変数と設定**  
  - `FLASK_ENV`、`DATABASE_URL`、`SECRET_KEY` などを `config.py` で整理。  
  - 開発用とテスト用で設定を切り替えている前提を README に書く。

- **ヘルスチェック**  
  - `GET /health` で「アプリ起動」だけ、または「DB 接続確認」を返す。  
  - ルートは薄く保ち、DB チェックは Service または専用の薄いモジュールにすると責務が明確。

- **ロギング**  
  - 既存の `logger` を活かし、リクエスト ID やユーザー ID をログに含めるかどうかを方針として決める。  
  - 実装は最小限（例: ミドルウェアでリクエスト ID を付与）でよい。

---

## 優先度の目安

| 優先度 | 項目 | 理由 |
|--------|------|------|
| 高 | 自分のノートだけ返す（get_all_notes に user_id） | 認可の一貫性とセキュリティの基礎 |
| 高 | 認可ロジックの共通化（小さな permission モジュール） | 責務分離とテストしやすさ |
| 中 | ノートの updated_at、一覧のソート・ページネーション | 実務でよくある API の形 |
| 中 | タグ or カテゴリ、下書き | ドメインを広げずに設計の練習になる |
| 中 | 検索・エラー形式の統一 | API の使いやすさ |
| 低 | ルートの軽いテスト、ヘルスチェック | 学習範囲を少し広げる程度 |
| 低 | ロギング・環境まわり | 余力があれば |

---

## 設計で守りたいこと

- **routes**: HTTP の入出力のみ。認可の「結果」を使うが、認可の判断は Service 側に寄せる。
- **services**: 業務ロジックと認可の判断。フレームワークに依存しない。
- **repository**: DB アクセスのみ。`user_id` によるフィルタやソート・ページネーションはここで実装。
- **過度な抽象化は避ける**: 学習目的なので、必要になったら 1 機能ずつ追加する形がよい。

---

## まとめ

- **まずは認可の整理**（「自分のノートだけ」「認可の共通化」）から入ると、今の設計の良さを活かしたまま一歩進めます。
- その次に **ノートの updated_at・ソート・ページネーション・検索** などで、Repository / Service の分離を体感できます。
- **タグ・カテゴリ・下書き** は、モデルと API の設計を少し広げる良い題材です。
- テストは **認可のテスト** を足し、必要なら **ルートの軽いテスト** まで。E2E は README のとおり対象外で問題ありません。

必要に応じて、上記のどれか 1 つを選んで「次の 1 機能」として詳細なタスクに分解することもできます。
